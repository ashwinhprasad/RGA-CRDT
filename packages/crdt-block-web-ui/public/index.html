<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Block CRDT Editor</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="app">
    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <h1 class="title">Block-Level CRDT Editor</h1>
        <div class="subtitle">Real-time collaborative editing powered by RGA (Replicated Growable Array)</div>
      </div>
      <div class="header-right">
        <!-- View Toggle -->
        <div class="view-toggle">
          <button class="view-toggle-btn active" data-tab="editor">
            <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
              <path d="M2 3.5a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5zm0 3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5zm0 3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5z"/>
            </svg>
            Editor
          </button>
          <button class="view-toggle-btn" data-tab="inspector">
            <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
              <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
              <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
            </svg>
            Inspector
          </button>
        </div>
        <div class="user-info">
          <span id="user-name">User</span>
          <span id="status" class="status">Connecting...</span>
        </div>
        <button id="toggle-online" class="btn btn-secondary">Go Offline</button>
      </div>
    </header>

    <!-- Presence bar -->
    <div class="presence-bar">
      <div class="presence-label">Active users:</div>
      <div id="presence" class="presence-list"></div>
      <div class="collaboration-hint">
        <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
          <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
          <path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286zm1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z"/>
        </svg>
        Open this page in multiple tabs or browsers to test real-time collaboration
      </div>
    </div>

    <!-- Editor Tab -->
    <div id="tab-editor" class="tab-content active">
      <!-- Editor -->
      <main class="editor-container">
        <div id="editor" class="editor">
          <div class="empty-state">Connecting to server...</div>
        </div>
      </main>
      
      <!-- Floating Action Toolbar -->
      <div class="floating-toolbar">
        <button id="add-paragraph" class="floating-btn" title="Add Paragraph">
          <svg width="18" height="18" viewBox="0 0 16 16" fill="currentColor">
            <path d="M2 4h12v1H2V4zm0 3h12v1H2V7zm0 3h12v1H2v-1z"/>
          </svg>
          <span>Paragraph</span>
        </button>
        <button id="add-list" class="floating-btn" title="Add List">
          <svg width="18" height="18" viewBox="0 0 16 16" fill="currentColor">
            <path d="M2 3.5a.5.5 0 1 1 1 0 .5.5 0 0 1-1 0zm3 0h9v1H5v-1zm0 4h9v1H5v-1zm0 4h9v1H5v-1zM2 7.5a.5.5 0 1 1 1 0 .5.5 0 0 1-1 0zm0 4a.5.5 0 1 1 1 0 .5.5 0 0 1-1 0z"/>
          </svg>
          <span>List</span>
        </button>
        <button id="add-table" class="floating-btn" title="Add Table">
          <svg width="18" height="18" viewBox="0 0 16 16" fill="currentColor">
            <path d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2zm15 2h-4v3h4V4zm0 4h-4v3h4V8zm0 4h-4v3h3a1 1 0 0 0 1-1v-2zm-5 3v-3H6v3h4zm-5 0v-3H1v2a1 1 0 0 0 1 1h3zm-4-4h4V8H1v3zm0-4h4V4H1v3zm5-3v3h4V4H6zm4 4H6v3h4V8z"/>
          </svg>
          <span>Table</span>
        </button>
      </div>
    </div>

    <!-- Algorithm Inspector Tab -->
    <div id="tab-inspector" class="tab-content">
      <div class="inspector-wrapper">
        <div class="inspector-intro">
          <h2>üîç How the CRDT Algorithm Works</h2>
          <p>This inspector shows you how the Conflict-free Replicated Data Type (CRDT) algorithm enables real-time collaboration without conflicts. Watch as operations flow through the system!</p>
          <div class="inspector-tips">
            <div class="tip tip-primary">
              <strong>üí° Try it now:</strong> Open this page in another browser tab or window, then type in both editors simultaneously to see the CRDT algorithm in action!
            </div>
          </div>
        </div>

        <div class="inspector-container">
          <!-- Operation Log -->
          <div class="inspector-panel">
          <div class="panel-header">
            <h3>üìù Operation Log</h3>
            <div class="panel-subtitle">Every edit creates an operation that's sent to all users</div>
            <div class="panel-help">
              <details>
                <summary>What are operations?</summary>
                <p>When you type a character, delete text, or add a block, it creates an "operation". These operations are sent to all connected users so everyone sees the same changes.</p>
                <ul>
                  <li><strong>INSERT</strong> - Adding new content (characters, blocks, list items)</li>
                  <li><strong>DELETE</strong> - Removing content</li>
                  <li><strong>BLOCK</strong> - Creating document structure (paragraphs, lists, tables)</li>
                </ul>
              </details>
            </div>
          </div>
          <div id="operation-log" class="operation-log"></div>
        </div>

        <!-- RGA Tree Visualization -->
        <div class="inspector-panel">
          <div class="panel-header">
            <h3>üå≥ Document Structure (RGA Tree)</h3>
            <div class="panel-subtitle">How your document is organized internally</div>
            <div class="panel-help">
              <details>
                <summary>What is the RGA tree?</summary>
                <p>RGA (Replicated Growable Array) is the data structure that keeps everything in order. Think of it like a family tree:</p>
                <ul>
                  <li><strong>HEAD</strong> - The root of the tree (starting point)</li>
                  <li><strong>Nodes</strong> - Each character or block is a node with a unique ID</li>
                  <li><strong>Children</strong> - Nodes inserted "after" another node become its children</li>
                  <li><strong>Tombstones</strong> - Deleted nodes stay in the tree but are marked as deleted</li>
                </ul>
                <p><em>Why keep deleted nodes?</em> So that operations arriving late can still find their correct position!</p>
              </details>
            </div>
            <div class="panel-controls">
              <label>
                <input type="checkbox" id="show-tombstones" checked>
                Show deleted nodes (tombstones)
              </label>
            </div>
          </div>
          <div id="rga-tree" class="rga-tree"></div>
        </div>

        <!-- Concurrent Operations -->
        <div class="inspector-panel">
          <div class="panel-header">
            <h3>üîÄ Concurrent Operations</h3>
            <div class="panel-subtitle">How the algorithm orders simultaneous edits from different users</div>
            <div class="panel-help">
              <details>
                <summary>What are concurrent operations?</summary>
                <p>CRDTs are "Conflict-Free" - they don't have conflicts! Instead, when multiple users edit simultaneously, the algorithm deterministically orders their operations:</p>
                <div class="conflict-explanation">
                  <div class="conflict-scenario">
                    <strong>Scenario:</strong> User R1 types "A" and User R2 types "B" at the same position
                  </div>
                  <div class="conflict-rule">
                    <strong>Rule:</strong> Sort by Replica ID (R1 < R2)
                  </div>
                  <div class="conflict-result">
                    <strong>Result:</strong> Everyone sees "AB" (not "BA")
                  </div>
                </div>
                <p>This deterministic ordering ensures all users converge to the same result without conflicts!</p>
              </details>
            </div>
          </div>
          <div id="conflict-log" class="conflict-log"></div>
        </div>

        <!-- Document State -->
        <div class="inspector-panel">
          <div class="panel-header">
            <h3>üìä Live Statistics</h3>
            <div class="panel-subtitle">Real-time metrics about your document</div>
            <div class="panel-help">
              <details>
                <summary>What do these numbers mean?</summary>
                <ul>
                  <li><strong>Replica ID</strong> - Your unique user number (assigned when you connect)</li>
                  <li><strong>Block Count</strong> - Number of paragraphs, lists, and tables</li>
                  <li><strong>Total Characters</strong> - All visible text in the document</li>
                  <li><strong>Operations</strong> - Total edits made (yours + others)</li>
                  <li><strong>Conflicts Resolved</strong> - Times the algorithm merged concurrent edits</li>
                </ul>
              </details>
            </div>
          </div>
          <div id="document-state" class="document-state"></div>
        </div>
      </div>

      <!-- Educational Footer -->
      <div class="inspector-footer">
        <div class="learning-section">
          <h4>üéì Understanding CRDTs</h4>
          <div class="learning-cards">
            <div class="learning-card">
              <div class="card-icon">üîë</div>
              <h5>Unique IDs</h5>
              <p>Every character gets an ID like [1, 42] meaning "Replica 1, operation 42". This makes every edit uniquely identifiable.</p>
            </div>
            <div class="learning-card">
              <div class="card-icon">üîó</div>
              <h5>Linked Structure</h5>
              <p>Each node knows what comes "after" it. When you type "Hi", 'i' is inserted after 'H', creating a chain.</p>
            </div>
            <div class="learning-card">
              <div class="card-icon">‚öñÔ∏è</div>
              <h5>Deterministic Order</h5>
              <p>When conflicts happen, the algorithm uses replica IDs to decide order. Same operations = same result everywhere!</p>
            </div>
            <div class="learning-card">
              <div class="card-icon">üëª</div>
              <h5>Tombstones</h5>
              <p>Deleted items aren't removed - they're marked as "deleted". This helps late-arriving operations find their place.</p>
            </div>
          </div>
        </div>
      </div>
      </div>
    </div>
  </div>

  <script type="module" src="client.js"></script>
</body>
</html>
